<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>algoChan - –ú–∏–Ω–∏-–§–æ—Ä—É–º</title>
  <style>
    :root {
      --background-color: #ffffff;
      --text-color: #3a006e;
      --border-color: #9a6cff;
      --button-bg-color: #7f6cff;
      --button-text-color: white;
    }
    .dark-theme {
      --background-color: #222;
      --text-color: #fff;
      --border-color: #bb86fc;
      --button-bg-color: #bb86fc;
      --button-text-color: #000;
    }
    body {
      background: var(--background-color);
      color: var(--text-color);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 0 15px;
      font-size: 16px;
    }
    h1, h2, h3 {
      font-weight: 600;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 8px;
      margin-bottom: 20px;
    }
    button {
      background: var(--button-bg-color);
      color: var(--button-text-color);
      border: 2px solid var(--border-color);
      padding: 7px 14px;
      cursor: pointer;
      font-family: inherit;
      font-size: 15px;
      border-radius: 5px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    button:hover {
      background: var(--border-color);
      color: var(--button-text-color);
    }
    input, textarea, select {
      border: 2px solid var(--border-color);
      background: #f8f6ff;
      color: var(--text-color);
      font-family: inherit;
      font-size: 15px;
      padding: 8px 10px;
      margin-bottom: 15px;
      width: 100%;
      box-sizing: border-box;
      border-radius: 6px;
      transition: border-color 0.3s ease;
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--border-color);
      outline: none;
      background: #f0eaff;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      border-bottom: 1.5px solid var(--border-color);
      padding: 10px 8px;
      cursor: pointer;
      list-style: none;
      transition: background-color 0.2s ease;
    }
    li:hover {
      background-color: #f0eaff;
    }
    .comment {
      border-top: 1.5px solid var(--border-color);
      padding: 10px 8px;
      margin-top: 10px;
      border-radius: 6px;
      background: #faf8ff;
    }
    .hidden {
      display: none;
    }
    #reactions-container button {
      border: 2px solid var(--border-color);
      background: #f8f6ff;
      margin: 4px;
      padding: 5px 9px;
      cursor: pointer;
      border-radius: 5px;
      font-size: 18px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    #reactions-container button.selected {
      background: var(--button-bg-color);
      color: white;
      border-color: var(--border-color);
    }
    #private-message-section {
      margin-top: 40px;
      border-top: 2px solid var(--border-color);
      padding-top: 20px;
    }
    #user-info {
      margin-bottom: 15px;
      font-weight: 600;
    }
    #btn-back {
      margin-bottom: 20px;
      background: #c7bfff;
      color: var(--text-color);
      border-color: #c7bfff;
    }
    #btn-back:hover {
      background: var(--border-color);
      color: white;
    }
    .comments, #private-message-section {
      max-height: 400px;
      overflow-y: auto;
    }
    .profile {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: #faf8ff;
    }
    .profile img {
      max-width: 100px;
      max-height: 100px;
      border-radius: 50%;
    }
    #search-section {
      margin-bottom: 20px;
    }
    #theme-section {
      margin-top: 20px;
    }
    .tag {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 14px;
      margin-right: 5px;
      color: white;
    }
    .tag-AI { background-color: #ffcccb; }
    .tag-Python { background-color: #add8e6; }
    .tag-IRL { background-color: #90ee90; }
    .tag-shitpost { background-color: #ffa500; }
    .profile-banner {
      background-size: cover;
      background-position: center;
      height: 150px;
      margin-bottom: 15px;
    }
    .profile-emoji {
      font-size: 20px;
    }
    .badges img {
      width: 30px;
      height: 30px;
      margin-right: 5px;
    }
    .trends {
      margin-top: 20px;
    }
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>
<header>
  <div class="header-container">
    <h1>algoChan –ú–∏–Ω–∏-–§–æ—Ä—É–º</h1>
    <button id="btn-profile" class="hidden">–ü—Ä–æ—Ñ–∏–ª—å</button>
  </div>
  <div id="user-info"></div>
</header>

<!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
<div id="auth-section">
  <button id="btn-google">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
  <button id="btn-anon">–í–æ–π—Ç–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ</button>
  <button id="btn-logout" class="hidden">–í—ã–π—Ç–∏</button>
</div>

<!-- –ü–æ–∏—Å–∫ -->
<div id="search-section" class="hidden">
  <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ä—É–º—É" />
  <button id="search-button">–ü–æ–∏—Å–∫</button>
</div>

<!-- –¢–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è -->
<div id="theme-section" class="hidden">
  <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
  <select id="theme-select">
    <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
    <option value="dark">–¢–µ–º–Ω–∞—è</option>
  </select>
  <button id="set-theme">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
</div>

<!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div id="profile-section" class="hidden">
  <button id="btn-back-to-forum">‚Üê –ù–∞–∑–∞–¥ –∫ —Ñ–æ—Ä—É–º—É</button>
  <button id="btn-exit-profile">–í—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è</button>
  <div class="profile">
    <div class="profile-banner" id="profile-banner"></div>
    <img id="profile-avatar" src="" alt="–ê–≤–∞—Ç–∞—Ä" />
    <h2 id="profile-nickname"></h2>
    <p class="profile-status" id="profile-status"></p>
    <p><b>ID:</b> <span id="profile-id"></span></p>
    <p><b>–†–µ–ø—É—Ç–∞—Ü–∏—è:</b> <span id="profile-reputation">0</span></p>
    <p><b>–û —Å–µ–±–µ:</b> <span id="profile-bio"></span></p>
    <p><b>–°—Ç–∞—Ç—É—Å –±–∞–Ω–∞:</b> <span id="profile-ban-status">–ù–µ –∑–∞–±–∞–Ω–µ–Ω</span></p>
    <h3>–ù–∞–≥—Ä–∞–¥—ã</h3>
    <div class="badges" id="profile-awards"></div>
    <div id="report-section">
      <button id="btn-report-user">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
      <div id="report-form" class="hidden">
        <textarea id="report-text" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –∂–∞–ª–æ–±—ã"></textarea>
        <button id="btn-send-report">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É</button>
      </div>
    </div>
    <div id="edit-profile-section" class="hidden">
      <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
      <input type="text" id="edit-nickname" placeholder="–ù–∏–∫–Ω–µ–π–º" />
      <input type="text" id="edit-status" placeholder="–°—Ç–∞—Ç—É—Å" />
      <textarea id="edit-bio" placeholder="–û —Å–µ–±–µ"></textarea>
      <input type="file" id="edit-avatar" accept="image/*" />
      <input type="file" id="edit-banner" accept="image/*" />
      <button id="btn-save-profile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <button id="btn-edit-profile">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
  </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Ç–µ–º –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–º—ã -->
<div id="forum-section" class="hidden">
  <h2>–¢–µ–º—ã</h2>
  <ul id="topics-list"></ul>
  <div id="topic-create">
    <h3>–°–æ–∑–¥–∞—Ç—å —Ç–µ–º—É</h3>
    <input type="text" id="topic-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" />
    <select id="topic-category">
      <option>–û–±—â–µ–µ</option>
      <option>–ü—Ä–æ–µ–∫—Ç—ã</option>
      <option>–†–µ–∫–ª–∞–º–∞</option>
      <option>–ê–Ω–∞—Ä—Ö–∏—è</option>
    </select>
    <input type="text" id="topic-tags" placeholder="#—Ç–µ–≥1 #—Ç–µ–≥2" />
    <textarea id="topic-content" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã"></textarea>
    <input type="file" id="upload-image" accept="image/*" />
    <button id="btn-create-topic">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
  </div>
  <div class="trends">
    <h3>üî• –°–µ–π—á–∞—Å –æ–±—Å—É–∂–¥–∞—é—Ç</h3>
    <ul id="trends-list"></ul>
  </div>
</div>

<!-- –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–º—ã -->
<div id="topic-view" class="hidden">
  <button id="btn-back">‚Üê –ù–∞–∑–∞–¥</button>
  <h2 id="view-title"></h2>
  <p id="view-content"></p>
  <div><b>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</b> <span id="view-category"></span></div>
  <div><b>–¢–µ–≥–∏:</b> <span id="view-tags"></span></div>
  <div style="margin-top:10px;">
    <button id="btn-like" class="vote-btn" title="–ù—Ä–∞–≤–∏—Ç—Å—è">üëç</button><span id="like-count">0</span>
    <button id="btn-dislike" class="vote-btn" title="–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è">üëé</button><span id="dislike-count">0</span>
  </div>
  <div id="reactions-container" style="margin-top:15px;">
    <span>–†–µ–∞–∫—Ü–∏–∏:</span>
    <button data-reaction="üòÅ" title="–£–ª—ã–±–∫–∞">üòÅ</button>
    <button data-reaction="üòé" title="–ö—Ä—É—Ç–æ">üòé</button>
    <button data-reaction="ü•µ" title="–ñ–∞—Ä–∫–æ">ü•µ</button>
    <button data-reaction="ü•∂" title="–•–æ–ª–æ–¥–Ω–æ">ü•∂</button>
    <button data-reaction="üò±" title="–£–∂–∞—Å">üò±</button>
    <button data-reaction="üëΩ" title="–ò–Ω–æ–ø–ª–∞–Ω–µ—Ç—è–Ω–∏–Ω">üëΩ</button>
    <button data-reaction="‚ò†Ô∏è" title="–°–º–µ—Ä—Ç—å">‚ò†Ô∏è</button>
    <button data-reaction="ü§°" title="–ö–ª–æ—É–Ω">ü§°</button>
    <button data-reaction="üòç" title="–í–ª—é–±–ª–µ–Ω">üòç</button>
    <button data-reaction="ü§ë" title="–ñ–∞–¥–Ω—ã–π">ü§ë</button>
    <button data-reaction="‚ù§Ô∏è" title="–õ—é–±–æ–≤—å">‚ù§Ô∏è</button>
  </div>
  <div class="comments">
    <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
    <ul id="comments-list"></ul>
    <div id="login-to-comment" class="hidden" style="color:#7f6cff;">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
    <div id="comment-form" class="hidden">
      <textarea id="comment-text" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
      <button id="btn-send-comment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
<div id="private-message-section" class="hidden">
  <h2>–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h2>
  <div>
    <label for="pm-recipient">–ü–æ–ª—É—á–∞—Ç–µ–ª—å (ID –∏–ª–∏ email):</label>
    <input type="text" id="pm-recipient" placeholder="ID –∏–ª–∏ email –ø–æ–ª—É—á–∞—Ç–µ–ª—è" />
    <textarea id="pm-text" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"></textarea>
    <button id="btn-send-pm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –õ–°</button>
  </div>
  <h3>–í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
  <ul id="pm-list"></ul>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    GoogleAuthProvider, signInWithPopup, signOut,
    signInAnonymously
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getDatabase, ref, push, set, onValue, off, update, increment, get, runTransaction
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import {
    getStorage, ref as storageRef, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjWwCTsgWogsKq1s6Xwo7GGf4dycw-Hxo",
    authDomain: "algodata-26fe6.firebaseapp.com",
    databaseURL: "https://algodata-26fe6-default-rtdb.firebaseio.com",
    projectId: "algodata-26fe6",
    storageBucket: "algodata-26fe6.appspot.com",
    messagingSenderId: "727358128981",
    appId: "1:727358128981:web:8eac1885ec167b1686e5dc",
    measurementId: "G-EXY8WDLX7N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  const btnGoogle = document.getElementById('btn-google');
  const btnAnon = document.getElementById('btn-anon');
  const btnLogout = document.getElementById('btn-logout');
  const btnProfile = document.getElementById('btn-profile');
  const userInfo = document.getElementById('user-info');
  const authSection = document.getElementById('auth-section');
  const forumSection = document.getElementById('forum-section');
  const topicsList = document.getElementById('topics-list');
  const topicCreate = document.getElementById('topic-create');
  const topicTitle = document.getElementById('topic-title');
  const topicContent = document.getElementById('topic-content');
  const topicCategory = document.getElementById('topic-category');
  const topicTags = document.getElementById('topic-tags');
  const btnCreateTopic = document.getElementById('btn-create-topic');
  const topicView = document.getElementById('topic-view');
  const btnBack = document.getElementById('btn-back');
  const viewTitle = document.getElementById('view-title');
  const viewContent = document.getElementById('view-content');
  const viewCategory = document.getElementById('view-category');
  const viewTags = document.getElementById('view-tags');
  const btnLike = document.getElementById('btn-like');
  const btnDislike = document.getElementById('btn-dislike');
  const likeCountSpan = document.getElementById('like-count');
  const dislikeCountSpan = document.getElementById('dislike-count');
  const reactionsContainer = document.getElementById('reactions-container');
  const commentsList = document.getElementById('comments-list');
  const loginToComment = document.getElementById('login-to-comment');
  const commentForm = document.getElementById('comment-form');
  const commentText = document.getElementById('comment-text');
  const btnSendComment = document.getElementById('btn-send-comment');
  const pmSection = document.getElementById('private-message-section');
  const pmRecipient = document.getElementById('pm-recipient');
  const pmText = document.getElementById('pm-text');
  const btnSendPm = document.getElementById('btn-send-pm');
  const pmList = document.getElementById('pm-list');
  const profileSection = document.getElementById('profile-section');
  const profileNickname = document.getElementById('profile-nickname');
  const profileAvatar = document.getElementById('profile-avatar');
  const profileId = document.getElementById('profile-id');
  const profileBio = document.getElementById('profile-bio');
  const profileAwards = document.getElementById('profile-awards');
  const profileReputation = document.getElementById('profile-reputation');
  const profileStatus = document.getElementById('profile-status');
  const profileBanner = document.getElementById('profile-banner');
  const btnBackToForum = document.getElementById('btn-back-to-forum');
  const btnExitProfile = document.getElementById('btn-exit-profile');
  const searchInput = document.getElementById('search-input');
  const searchButton = document.getElementById('search-button');
  const themeSelect = document.getElementById('theme-select');
  const setThemeButton = document.getElementById('set-theme');
  const uploadImageInput = document.getElementById('upload-image');
  const searchSection = document.getElementById('search-section');
  const themeSection = document.getElementById('theme-section');
  const trendsList = document.getElementById('trends-list');
  const editProfileSection = document.getElementById('edit-profile-section');
  const editNickname = document.getElementById('edit-nickname');
  const editStatus = document.getElementById('edit-status');
  const editBio = document.getElementById('edit-bio');
  const editAvatar = document.getElementById('edit-avatar');
  const editBanner = document.getElementById('edit-banner');
  const btnEditProfile = document.getElementById('btn-edit-profile');
  const btnSaveProfile = document.getElementById('btn-save-profile');
  const btnReportUser = document.getElementById('btn-report-user');
  const reportForm = document.getElementById('report-form');
  const reportText = document.getElementById('report-text');
  const btnSendReport = document.getElementById('btn-send-report');
  const profileBanStatus = document.getElementById('profile-ban-status');

  let currentUser = null;
  let currentTopicId = null;
  let currentUserIsAnonymous = true;
  let currentProfileUserId = null;

  // –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google
  btnGoogle.onclick = async () => {
    try {
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email
      const usersRef = ref(db, "users");
      const snapshot = await get(usersRef);
      const users = snapshot.val() || {};
      const emailExists = Object.values(users).some(u => u.email === user.email && u.uid !== user.uid);
      if (emailExists) {
        await signOut(auth);
        alert("–≠—Ç–æ—Ç email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.");
        return;
      }
      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      await set(ref(db, `users/${user.uid}`), {
        email: user.email,
        nickname: user.displayName || "–ë–µ–∑ –∏–º–µ–Ω–∏",
        avatar: user.photoURL || "",
        reputation: 0,
        createdAt: Date.now()
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google:', error);
      alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google: ' + error.message);
    }
  };

  // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥
  btnAnon.onclick = async () => {
    try {
      await signInAnonymously(auth);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –≤—Ö–æ–¥–∞:', error);
      alert('–û—à–∏–±–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –≤—Ö–æ–¥–∞: ' + error.message);
    }
  };

  // –í—ã—Ö–æ–¥
  btnLogout.onclick = async () => {
    try {
      await signOut(auth);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
      alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message);
    }
  };

  // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é
  btnProfile.onclick = () => {
    if (currentUser) {
      viewUserProfile(currentUser.uid);
    } else {
      alert("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.");
    }
  };

  btnExitProfile.onclick = () => {
    profileSection.classList.add("hidden");
    forumSection.classList.remove("hidden");
  };

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  function showUser(user) {
    if (!user) {
      userInfo.textContent = "–í—ã –Ω–µ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É";
      authSection.classList.remove("hidden");
      forumSection.classList.add("hidden");
      topicView.classList.add("hidden");
      pmSection.classList.add("hidden");
      profileSection.classList.add("hidden");
      btnLogout.classList.add("hidden");
      btnProfile.classList.add("hidden");
      topicCreate.style.display = "none";
      loginToComment.classList.add("hidden");
      commentForm.classList.add("hidden");
      searchSection.classList.add("hidden");
      themeSection.classList.add("hidden");
      return;
    }
    currentUser = user;
    currentUserIsAnonymous = user.isAnonymous;
    userInfo.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.isAnonymous ? "–ê–Ω–æ–Ω–∏–º" : (user.email || "–ë–µ–∑ email")}`;
    authSection.classList.add("hidden");
    forumSection.classList.remove("hidden");
    btnLogout.classList.remove("hidden");
    btnProfile.classList.remove("hidden");
    topicCreate.style.display = currentUserIsAnonymous ? "none" : "block";
    pmSection.classList.remove("hidden");
    searchSection.classList.remove("hidden");
    themeSection.classList.remove("hidden");
    if (!user.isAnonymous) {
      loadUserProfile(user.uid);
    }
  }

  onAuthStateChanged(auth, async user => {
    showUser(user);
    if (user) {
      loadTopics();
      loadPrivateMessages();
      loadTrends();
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–∞–Ω–∞
      if (!user.isAnonymous) {
        const banStatus = await checkBanStatus(user.uid);
        if (banStatus.isBanned) {
          userInfo.textContent += ` (–ó–∞–±–∞–Ω–µ–Ω –¥–æ ${new Date(banStatus.banUntil).toLocaleString()})`;
          topicCreate.style.display = "none";
        }
      }
    }
  });

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–∞–Ω–∞
  async function checkBanStatus(userId) {
    const userRef = ref(db, `users/${userId}`);
    const snapshot = await get(userRef);
    const userData = snapshot.val() || {};
    const now = Date.now();
    if (userData.banUntil && userData.banUntil > now) {
      return { isBanned: true, banUntil: userData.banUntil };
    }
    return { isBanned: false };
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
  async function loadUserProfile(userId) {
    const userRef = ref(db, `users/${userId}`);
    try {
      const snapshot = await get(userRef);
      if (snapshot.exists()) {
        const userData = snapshot.val();
        if (userData.avatar) profileAvatar.src = userData.avatar;
        if (userData.nickname) profileNickname.textContent = userData.nickname + (userData.emoji || "");
        if (userData.bio) profileBio.textContent = userData.bio;
        if (userData.reputation) profileReputation.textContent = userData.reputation;
        if (userData.status) profileStatus.textContent = userData.status;
        if (userData.banner) profileBanner.style.backgroundImage = `url(${userData.banner})`;
        profileId.textContent = userId;
        if (userData.awards) {
          profileAwards.innerHTML = userData.awards.map(award => `<img src="${award}" alt="Badge" title="Badge">`).join('');
        }
        profileBanStatus.textContent = userData.banUntil && userData.banUntil > Date.now()
          ? `–ó–∞–±–∞–Ω–µ–Ω –¥–æ ${new Date(userData.banUntil).toLocaleString()}`
          : "–ù–µ –∑–∞–±–∞–Ω–µ–Ω";
        applyTheme(userData.theme);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
    }
  }

  // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
  function applyTheme(theme) {
    if (theme === 'dark') {
      document.body.classList.add('dark-theme');
    } else {
      document.body.classList.remove('dark-theme');
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º
  function loadTopics() {
    const topicsRef = ref(db, "topics");
    onValue(topicsRef, (snapshot) => {
      const data = snapshot.val() || {};
      topicsList.innerHTML = "";
      for (const [id, topic] of Object.entries(data)) {
        const li = document.createElement('li');
        li.innerHTML = `${topic.title} [${topic.category}] ${topic.tags ? topic.tags.map(tag => `<span class="tag tag-${tag}">#${tag}</span>`).join(" ") : ""}`;
        li.dataset.id = id;
        topicsList.appendChild(li);
      }
    });
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ —Ç–µ–º (3 –≤ –Ω–µ–¥–µ–ª—é)
  async function checkTopicLimit(userId) {
    const weekStart = getWeekStart();
    const topicCountRef = ref(db, `userTopicCounts/${userId}/${weekStart}`);
    const snapshot = await get(topicCountRef);
    const count = snapshot.exists() ? snapshot.val() : 0;
    return count < 3;
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
  function getWeekStart() {
    const now = new Date();
    const dayOfWeek = now.getDay();
    const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
    const weekStart = new Date(now.setDate(diff));
    weekStart.setHours(0, 0, 0, 0);
    return weekStart.getTime();
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–º—ã
  btnCreateTopic.onclick = async () => {
    if (!currentUser) {
      alert("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–µ–º—ã.");
      return;
    }
    if (currentUserIsAnonymous) {
      alert("–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–µ–º—ã.");
      return;
    }
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–∞–Ω–∞
    const banStatus = await checkBanStatus(currentUser.uid);
    if (banStatus.isBanned) {
      alert(`–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –¥–æ ${new Date(banStatus.banUntil).toLocaleString()}. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–º –∑–∞–ø—Ä–µ—â–µ–Ω–æ.`);
      return;
    }
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ —Ç–µ–º
    const canCreateTopic = await checkTopicLimit(currentUser.uid);
    if (!canCreateTopic) {
      alert("–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –≤ 3 —Ç–µ–º—ã –Ω–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é.");
      return;
    }
    const title = topicTitle.value.trim();
    const content = topicContent.value.trim();
    const category = topicCategory.value;
    const tagsRaw = topicTags.value.trim();
    if (!title || !content) {
      alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã.");
      return;
    }
    const tags = tagsRaw.split(/\s+/).filter(t => t.startsWith("#")).map(t => t.substring(1));
    const newTopicRef = push(ref(db, "topics"));
    try {
      await set(newTopicRef, {
        title, content, category, tags,
        author: currentUser.uid,
        createdAt: Date.now(),
        likes: 0,
        dislikes: 0,
        reactions: {},
      });
      // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Ç–µ–º
      const weekStart = getWeekStart();
      const topicCountRef = ref(db, `userTopicCounts/${currentUser.uid}/${weekStart}`);
      await runTransaction(topicCountRef, count => (count || 0) + 1);
      await addReputation(currentUser.uid, 10);
      topicTitle.value = "";
      topicContent.value = "";
      topicTags.value = "";
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–º—ã:', error);
      alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–º—ã: ' + error.message);
    }
  };

  topicsList.onclick = (e) => {
    if (e.target.tagName !== "LI") return;
    const topicId = e.target.dataset.id;
    openTopic(topicId);
  };

  async function openTopic(topicId) {
    const topicRef = ref(db, "topics/" + topicId);
    try {
      const snapshot = await get(topicRef);
      if (!snapshot.exists()) {
        alert("–¢–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
        return;
      }
      const topic = snapshot.val();
      currentTopicId = topicId;
      viewTitle.textContent = topic.title;
      viewContent.textContent = topic.content;
      viewCategory.textContent = topic.category;
      viewTags.innerHTML = topic.tags ? topic.tags.map(tag => `<span class="tag tag-${tag}">#${tag}</span>`).join(" ") : "";
      likeCountSpan.textContent = topic.likes || 0;
      dislikeCountSpan.textContent = topic.dislikes || 0;
      forumSection.classList.add("hidden");
      topicView.classList.remove("hidden");
      pmSection.classList.add("hidden");
      loadComments(topicId);
      updateReactionsUI(topic.reactions || {});
      updateVoteButtons(topic.likes || 0, topic.dislikes || 0);
      updateCommentSectionVisibility();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ç–µ–º—ã:', error);
    }
  }

  btnBack.onclick = () => {
    currentTopicId = null;
    topicView.classList.add("hidden");
    forumSection.classList.remove("hidden");
    pmSection.classList.remove("hidden");
    commentsList.innerHTML = "";
  };

  btnLike.onclick = () => {
    if (!currentUser) {
      alert("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å");
      return;
    }
    vote(currentTopicId, currentUser.uid, true);
  };

  btnDislike.onclick = () => {
    if (!currentUser) {
      alert("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å");
      return;
    }
    vote(currentTopicId, currentUser.uid, false);
  };

  async function vote(topicId, userId, isLike) {
    const topicRef = ref(db, "topics/" + topicId);
    const userVoteRef = ref(db, `topicVotes/${topicId}/${userId}`);
    try {
      const voteSnap = await get(userVoteRef);
      const oldVote = voteSnap.exists() ? voteSnap.val() : null;
      if (oldVote === (isLike ? "like" : "dislike")) {
        await runTransaction(topicRef, (topic) => {
          if (!topic) return topic;
          if (isLike) topic.likes = (topic.likes || 0) - 1;
          else topic.dislikes = (topic.dislikes || 0) - 1;
          return topic;
        });
        await set(userVoteRef, null);
      } else {
        await runTransaction(topicRef, (topic) => {
          if (!topic) return topic;
          if (oldVote === "like") topic.likes = (topic.likes || 0) - 1;
          if (oldVote === "dislike") topic.dislikes = (topic.dislikes || 0) - 1;
          if (isLike) topic.likes = (topic.likes || 0) + 1;
          else topic.dislikes = (topic.dislikes || 0) + 1;
          return topic;
        });
        await set(userVoteRef, isLike ? "like" : "dislike");
      }
      const topicSnap = await get(topicRef);
      const topic = topicSnap.val();
      likeCountSpan.textContent = topic.likes || 0;
      dislikeCountSpan.textContent = topic.dislikes || 0;
      updateVoteButtons(topic.likes || 0, topic.dislikes || 0);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:', error);
    }
  }

  async function updateVoteButtons(likes, dislikes) {
    if (!currentUser) {
      btnLike.classList.remove("selected");
      btnDislike.classList.remove("selected");
      return;
    }
    const userVoteRef = ref(db, `topicVotes/${currentTopicId}/${currentUser.uid}`);
    try {
      const voteSnap = await get(userVoteRef);
      const userVote = voteSnap.exists() ? voteSnap.val() : null;
      btnLike.classList.toggle("selected", userVote === "like");
      btnDislike.classList.toggle("selected", userVote === "dislike");
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:', error);
    }
  }

  reactionsContainer.onclick = async (e) => {
    if (e.target.tagName !== "BUTTON") return;
    if (!currentUser) {
      alert("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏–∏");
      return;
    }
    const reaction = e.target.dataset.reaction;
    if (!reaction) return;
    const reactionRef = ref(db, `topics/${currentTopicId}/reactions/${currentUser.uid}`);
    try {
      const snap = await get(reactionRef);
      const currentReaction = snap.exists() ? snap.val() : null;
      if (currentReaction === reaction) {
        await set(reactionRef, null);
        e.target.classList.remove("selected");
      } else {
        await set(reactionRef, reaction);
        const buttons = reactionsContainer.querySelectorAll("button");
        buttons.forEach(btn => btn.classList.toggle("selected", btn.dataset.reaction === reaction));
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–∞–∫—Ü–∏–∏:', error);
    }
  };

  async function updateReactionsUI(reactions) {
    const userReaction = currentUser ? reactions[currentUser.uid] : null;
    const buttons = reactionsContainer.querySelectorAll("button");
    buttons.forEach(btn => {
      btn.classList.toggle("selected", btn.dataset.reaction === userReaction);
    });
  }

  function loadComments(topicId) {
    const commentsRef = ref(db, "comments/" + topicId);
    off(commentsRef);
    onValue(commentsRef, (snapshot) => {
      const data = snapshot.val() || {};
      commentsList.innerHTML = "";
      for (const [id, comment] of Object.entries(data)) {
        const li = document.createElement('li');
        li.className = "comment";
        const author = comment.author || "–ì–æ—Å—Ç—å";
        const date = new Date(comment.createdAt || 0).toLocaleString();
        li.innerHTML = `<b><span class="comment-author" data-id="${comment.authorId}">${author}</span></b> <small style="color:#7f6cff;">${date}</small><br>${comment.text}`;
        commentsList.appendChild(li);
      }
      document.querySelectorAll('.comment-author').forEach(author => {
        author.onclick = () => {
          const userId = author.dataset.id;
          viewUserProfile(userId);
        };
      });
    });
  }

  async function viewUserProfile(userId) {
    currentProfileUserId = userId;
    const userRef = ref(db, "users/" + userId);
    try {
      const snapshot = await get(userRef);
      if (snapshot.exists()) {
        const userData = snapshot.val();
        profileNickname.textContent = userData.nickname || "–ë–µ–∑ –∏–º–µ–Ω–∏";
        profileId.textContent = userId;
        profileBio.textContent = userData.bio || "–ù–µ—Ç –±–∏–æ–≥—Ä–∞—Ñ–∏–∏";
        profileReputation.textContent = userData.reputation || "0";
        profileStatus.textContent = userData.status || "–ù–µ—Ç —Å—Ç–∞—Ç—É—Å–∞";
        profileAvatar.src = userData.avatar || "";
        if (userData.banner) profileBanner.style.backgroundImage = `url(${userData.banner})`;
        if (userData.awards) {
          profileAwards.innerHTML = userData.awards.map(award => `<img src="${award}" alt="Badge" title="Badge">`).join('');
        } else {
          profileAwards.innerHTML = "<p>–ù–µ—Ç –Ω–∞–≥—Ä–∞–¥</p>";
        }
        profileBanStatus.textContent = userData.banUntil && userData.banUntil > Date.now()
          ? `–ó–∞–±–∞–Ω–µ–Ω –¥–æ ${new Date(userData.banUntil).toLocaleString()}`
          : "–ù–µ –∑–∞–±–∞–Ω–µ–Ω";
        forumSection.classList.add("hidden");
        topicView.classList.add("hidden");
        pmSection.classList.add("hidden");
        profileSection.classList.remove("hidden");
        reportSection.classList.toggle("hidden", currentUser && userId === currentUser.uid);
      } else {
        alert("–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω");
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è:', error);
    }
  }

  btnBackToForum.onclick = () => {
    profileSection.classList.add("hidden");
    forumSection.classList.remove("hidden");
  };

  btnEditProfile.onclick = () => {
    editProfileSection.classList.toggle("hidden");
  };

  btnSaveProfile.onclick = async () => {
    const nickname = editNickname.value.trim();
    const status = editStatus.value.trim();
    const bio = editBio.value.trim();
    const avatarFile = editAvatar.files[0];
    const bannerFile = editBanner.files[0];

    try {
      let avatarUrl = profileAvatar.src;
      let bannerUrl = profileBanner.style.backgroundImage ? profileBanner.style.backgroundImage.slice(5, -2) : "";

      if (avatarFile) {
        avatarUrl = await uploadImage(avatarFile);
      }
      if (bannerFile) {
        bannerUrl = await uploadImage(bannerFile);
      }

      const userRef = ref(db, `users/${currentUser.uid}`);
      await set(userRef, {
        nickname,
        status,
        bio,
        avatar: avatarUrl,
        banner: bannerUrl,
        email: currentUser.email,
        reputation: (await get(userRef)).val()?.reputation || 0,
        createdAt: (await get(userRef)).val()?.createdAt || Date.now()
      });

      alert("–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
      loadUserProfile(currentUser.uid);
      editProfileSection.classList.add("hidden");
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
      alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
    }
  };

  async function uploadImage(file) {
    const storageReference = storageRef(storage, `images/${file.name}`);
    try {
      await uploadBytes(storageReference, file);
      return await getDownloadURL(storageReference);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', error);
      throw error;
    }
  }

  btnSendComment.onclick = async () => {
    if (!currentUser) {
      alert("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å.");
      return;
    }
    const text = commentText.value.trim();
    if (!text) {
      alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è");
      return;
    }
    const newCommentRef = push(ref(db, "comments/" + currentTopicId));
    try {
      await set(newCommentRef, {
        text,
        author: currentUser.email || "–ê–Ω–æ–Ω–∏–º",
        authorId: currentUser.uid,
        createdAt: Date.now(),
      });
      await addReputation(currentUser.uid, 5);
      commentText.value = "";
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', error);
    }
  };

  function updateCommentSectionVisibility() {
    if (currentUser && !currentUserIsAnonymous) {
      loginToComment.classList.add("hidden");
      commentForm.classList.remove("hidden");
    } else {
      loginToComment.classList.remove("hidden");
      commentForm.classList.add("hidden");
    }
  }

  btnSendPm.onclick = async () => {
    if (!currentUser) {
      alert("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –õ–°");
      return;
    }
    const recipient = pmRecipient.value.trim();
    const text = pmText.value.trim();
    if (!recipient || !text) {
      alert("–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ email –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è");
      return;
    }
    let recipientId = recipient;
    if (recipient.includes('@')) {
      const usersRef = ref(db, "users");
      try {
        const snapshot = await get(usersRef);
        const users = snapshot.val() || {};
        const user = Object.entries(users).find(([id, userData]) => userData.email === recipient);
        if (user) {
          recipientId = user[0];
        } else {
          alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω");
          return;
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        return;
      }
    }
    const newPmRef = push(ref(db, "privateMessages"));
    try {
      await set(newPmRef, {
        from: currentUser.uid,
        to: recipientId,
        text,
        createdAt: Date.now(),
      });
      pmRecipient.value = "";
      pmText.value = "";
      alert("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
      loadPrivateMessages();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –õ–°:', error);
    }
  };

  function loadPrivateMessages() {
    if (!currentUser || currentUserIsAnonymous) {
      pmList.innerHTML = "<li>–í–æ–π–¥–∏—Ç–µ —Å –ø–æ—á—Ç–æ–π, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.</li>";
      return;
    }
    const pmRef = ref(db, "privateMessages");
    onValue(pmRef, (snapshot) => {
      const data = snapshot.val() || {};
      pmList.innerHTML = "";
      for (const [id, msg] of Object.entries(data)) {
        if (msg.to === currentUser.uid) {
          const li = document.createElement('li');
          const date = new Date(msg.createdAt || 0).toLocaleString();
          li.innerHTML = `<b>–û—Ç: ${msg.from}</b> <small style="color:#7f6cff;">${date}</small><br>${msg.text}`;
          pmList.appendChild(li);
        }
      }
      if (pmList.children.length === 0) {
        pmList.innerHTML = "<li>–ù–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</li>";
      }
    });
  }

  async function addReputation(userId, points) {
    const userRef = ref(db, `users/${userId}/reputation`);
    try {
      await runTransaction(userRef, (currentPoints) => {
        return (currentPoints || 0) + points;
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ø—É—Ç–∞—Ü–∏–∏:', error);
    }
  }

  searchButton.onclick = async () => {
    const keyword = searchInput.value.trim();
    if (!keyword) {
      alert("–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞.");
      return;
    }
    try {
      const results = await searchTopics(keyword);
      topicsList.innerHTML = results.map(topic =>
        `<li data-id="${topic.id}">${topic.title} [${topic.category}] ${topic.tags ? topic.tags.map(tag => `<span class="tag tag-${tag}">#${tag}</span>`).join(" ") : ""}</li>`
      ).join('');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
    }
  };

  async function searchTopics(keyword) {
    const topicsRef = ref(db, "topics");
    try {
      const snapshot = await get(topicsRef);
      const topics = snapshot.val() || {};
      return Object.entries(topics).filter(([id, topic]) =>
        topic.title.includes(keyword) || topic.content.includes(keyword)
      ).map(([id, topic]) => ({ id, ...topic }));
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ç–µ–º:', error);
      return [];
    }
  }

  setThemeButton.onclick = async () => {
    const theme = themeSelect.value;
    try {
      await setUserTheme(currentUser.uid, theme);
      alert(`–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${theme}`);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–µ–º—ã:', error);
    }
  };

  async function setUserTheme(userId, theme) {
    const userRef = ref(db, `users/${userId}/theme`);
    try {
      await set(userRef, theme);
      applyTheme(theme);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–º—ã:', error);
    }
  }

  uploadImageInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const imageUrl = await uploadImage(file);
      topicContent.value += `\n![Image](${imageUrl})`;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
    }
  };

  async function loadTrends() {
    const topicsRef = ref(db, "topics");
    try {
      const snapshot = await get(topicsRef);
      const topics = snapshot.val() || {};
      const trends = Object.entries(topics)
        .sort((a, b) => (b[1].likes || 0) - (a[1].likes || 0))
        .slice(0, 5)
        .map(([id, topic]) => ({ id, ...topic }));
      trendsList.innerHTML = trends.map(trend =>
        `<li data-id="${trend.id}">${trend.title} [${trend.category}] ${trend.tags ? trend.tags.map(tag => `<span class="tag tag-${tag}">#${tag}</span>`).join(" ") : ""}</li>`
      ).join('');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤:', error);
    }
  }

  // –°–∏—Å—Ç–µ–º–∞ –∂–∞–ª–æ–±
  btnReportUser.onclick = () => {
    reportForm.classList.toggle("hidden");
  };

  btnSendReport.onclick = async () => {
    if (!currentUser || currentUserIsAnonymous) {
      alert("–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∂–∞–ª–æ–±—ã.");
      return;
    }
    if (!currentProfileUserId) {
      alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω.");
      return;
    }
    if (currentProfileUserId === currentUser.uid) {
      alert("–ù–µ–ª—å–∑—è –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è.");
      return;
    }
    const reason = reportText.value.trim();
    if (!reason) {
      alert("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã.");
      return;
    }
    try {
      const reportRef = push(ref(db, `reports/${currentProfileUserId}`));
      await set(reportRef, {
        from: currentUser.uid,
        reason,
        createdAt: Date.now()
      });
      alert("–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.");
      reportText.value = "";
      reportForm.classList.add("hidden");
      await handleReports(currentProfileUserId);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã:', error);
      alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã: ' + error.message);
    }
  };

  async function handleReports(userId) {
    const reportsRef = ref(db, `reports/${userId}`);
    const snapshot = await get(reportsRef);
    const reports = snapshot.val() || {};
    const reportCount = Object.keys(reports).length;
    const userRef = ref(db, `users/${userId}`);
    let banUntil = null;

    if (reportCount >= 12) {
      banUntil = -1; // –ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π –±–∞–Ω
    } else if (reportCount >= 9) {
      banUntil = Date.now() + 10 * 24 * 60 * 60 * 1000; // 10 –¥–Ω–µ–π
    } else if (reportCount >= 6) {
      banUntil = Date.now() + 7 * 24 * 60 * 60 * 1000; // 7 –¥–Ω–µ–π
    } else if (reportCount >= 3) {
      banUntil = Date.now() + 5 * 60 * 60 * 1000; // 5 —á–∞—Å–æ–≤
    }

    if (banUntil) {
      await update(userRef, { banUntil });
      if (userId === currentUser?.uid) {
        userInfo.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${currentUser.email} (–ó–∞–±–∞–Ω–µ–Ω –¥–æ ${banUntil === -1 ? "–ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–æ" : new Date(banUntil).toLocaleString()})`;
        topicCreate.style.display = "none";
      }
    }
  }
</script>
</body>
</html>
